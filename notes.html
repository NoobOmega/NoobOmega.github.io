<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ ç¬”è®° - noobomegaçš„åšå®¢</title>
    <link rel="stylesheet" href="styles/style.css">
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">â† è¿”å›é¦–é¡µ</a>
        
        <div class="content-page">
            <h2>ğŸ“š å­¦ä¹ ç¬”è®°</h2>
            
            <!-- å…¬å¼€ç¬”è®°åŒºåŸŸ -->
            <div id="public-notes">
                <h3>çŸ¥è¯†åº“</h3>
                <div class="search-box">
                    <input type="text" id="note-search" placeholder="æœç´¢ç¬”è®°..." onkeyup="notesManager.searchNotes(this.value)">
                </div>
                <div id="public-notes-list" class="notes-container"></div>
            </div>
            
            <!-- ç®¡ç†å‘˜åŠŸèƒ½åŒºåŸŸ -->
            <div id="admin-notes" style="display: none;">
                <h3>ç¬”è®°ç®¡ç†</h3>
                <div class="admin-tools">
                    <button onclick="notesManager.showCreateForm()" class="btn btn-primary">æ–°å»ºç¬”è®°</button>
                    <button onclick="notesManager.exportNotes()" class="btn btn-secondary">å¯¼å‡ºç¬”è®°</button>
                    <select id="category-filter" onchange="notesManager.filterByCategory(this.value)">
                        <option value="">æ‰€æœ‰åˆ†ç±»</option>
                    </select>
                </div>
                
                <!-- åˆ›å»ºç¬”è®°è¡¨å• -->
                <div id="create-note-form" style="display: none;" class="create-form">
                    <h4>åˆ›å»ºæ–°ç¬”è®°</h4>
                    <form id="new-note-form">
                        <input type="text" id="note-title" placeholder="ç¬”è®°æ ‡é¢˜" required>
                        <select id="note-category">
                            <option value="æŠ€æœ¯">æŠ€æœ¯</option>
                            <option value="å­¦ä¹ ">å­¦ä¹ </option>
                            <option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                        <textarea id="note-content" placeholder="ç¬”è®°å†…å®¹ï¼ˆæ”¯æŒMarkdownï¼‰..." rows="10" required></textarea>
                        <div class="form-options">
                            <label>
                                <input type="checkbox" id="note-private"> ç§æœ‰ç¬”è®°ï¼ˆä»…è‡ªå·±å¯è§ï¼‰
                            </label>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn btn-primary">ä¿å­˜ç¬”è®°</button>
                            <button type="button" onclick="notesManager.hideCreateForm()" class="btn btn-secondary">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                
                <div id="notes-management" class="notes-management"></div>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/common.js"></script>
    <script src="js/admin.js"></script>
    <script>
        // ç¬”è®°ç®¡ç†åŠŸèƒ½
        const notesManager = {
            notes: JSON.parse(localStorage.getItem('blogNotes')) || [],
            categories: ['æŠ€æœ¯', 'å­¦ä¹ ', 'ç”Ÿæ´»', 'å…¶ä»–'],
            
            init: function() {
                if (!auth.checkPagePermission()) return;
                
                this.populateCategories();
                this.displayPublicNotes();
                
                if (auth.isAdmin()) {
                    document.getElementById('admin-notes').style.display = 'block';
                    this.displayManagementInterface();
                }
                
                // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
                document.getElementById('new-note-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    notesManager.createNewNote();
                });
            },
            
            populateCategories: function() {
                const filterSelect = document.getElementById('category-filter');
                this.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    filterSelect.appendChild(option);
                });
            },
            
            displayPublicNotes: function() {
                const publicNotes = this.notes.filter(note => !note.private);
                const notesList = document.getElementById('public-notes-list');
                
                if (publicNotes.length === 0) {
                    notesList.innerHTML = '<div class="empty-state">æš‚æ— å…¬å¼€ç¬”è®°</div>';
                    return;
                }
                
                // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                publicNotes.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                notesList.innerHTML = publicNotes.map(note => `
                    <div class="note-item" data-category="${note.category}">
                        <div class="note-header">
                            <h4>${this.escapeHtml(note.title)}</h4>
                            <span class="note-category">${note.category}</span>
                        </div>
                        <div class="note-content">${this.renderMarkdown(note.content)}</div>
                        <div class="note-meta">
                            <span class="note-date">${new Date(note.date).toLocaleDateString()}</span>
                        </div>
                    </div>
                `).join('');
            },
            
            displayManagementInterface: function() {
                const managementDiv = document.getElementById('notes-management');
                
                if (this.notes.length === 0) {
                    managementDiv.innerHTML = '<div class="empty-state">æš‚æ— ç¬”è®°ï¼Œåˆ›å»ºä½ çš„ç¬¬ä¸€ç¯‡ç¬”è®°å§ï¼</div>';
                    return;
                }
                
                // æŒ‰æ—¥æœŸæ’åº
                const sortedNotes = [...this.notes].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                managementDiv.innerHTML = sortedNotes.map((note, index) => `
                    <div class="note-item management-item" data-category="${note.category}">
                        <div class="note-header">
                            <h4>${this.escapeHtml(note.title)}</h4>
                            <div>
                                <span class="note-category">${note.category}</span>
                                <span class="note-badge ${note.private ? 'private' : 'public'}">
                                    ${note.private ? 'ç§æœ‰' : 'å…¬å¼€'}
                                </span>
                            </div>
                        </div>
                        <div class="note-content">${this.renderMarkdown(note.content)}</div>
                        <div class="note-meta">
                            <span class="note-date">${new Date(note.date).toLocaleString()}</span>
                            <div class="note-actions">
                                <button onclick="notesManager.editNote(${index})" class="btn btn-small">ç¼–è¾‘</button>
                                <button onclick="notesManager.deleteNote(${index})" class="btn btn-small btn-danger">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            },
            
            showCreateForm: function() {
                document.getElementById('create-note-form').style.display = 'block';
            },
            
            hideCreateForm: function() {
                document.getElementById('create-note-form').style.display = 'none';
                document.getElementById('new-note-form').reset();
            },
            
            createNewNote: function() {
                const title = document.getElementById('note-title').value;
                const category = document.getElementById('note-category').value;
                const content = document.getElementById('note-content').value;
                const isPrivate = document.getElementById('note-private').checked;
                
                if (!title.trim() || !content.trim()) {
                    alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹ï¼');
                    return;
                }
                
                const newNote = {
                    id: Date.now(),
                    title: title.trim(),
                    category: category,
                    content: content.trim(),
                    date: new Date().toISOString(),
                    private: isPrivate
                };
                
                this.notes.push(newNote);
                this.saveNotes();
                this.hideCreateForm();
                this.displayManagementInterface();
                this.displayPublicNotes();
                
                alert('ç¬”è®°åˆ›å»ºæˆåŠŸï¼');
            },
            
            editNote: function(index) {
                const note = this.notes[index];
                const newTitle = prompt('ä¿®æ”¹æ ‡é¢˜ï¼š', note.title);
                const newContent = prompt('ä¿®æ”¹å†…å®¹ï¼š', note.content);
                
                if (newTitle !== null && newContent !== null) {
                    this.notes[index].title = newTitle;
                    this.notes[index].content = newContent;
                    this.notes[index].date = new Date().toISOString();
                    this.saveNotes();
                    this.displayManagementInterface();
                    this.displayPublicNotes();
                }
            },
            
            deleteNote: function(index) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡ç¬”è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    this.notes.splice(index, 1);
                    this.saveNotes();
                    this.displayManagementInterface();
                    this.displayPublicNotes();
                }
            },
            
            searchNotes: function(query) {
                const notes = document.querySelectorAll('.note-item');
                const searchTerm = query.toLowerCase();
                
                notes.forEach(note => {
                    const title = note.querySelector('h4').textContent.toLowerCase();
                    const content = note.querySelector('.note-content').textContent.toLowerCase();
                    const matches = title.includes(searchTerm) || content.includes(searchTerm);
                    note.style.display = matches ? 'block' : 'none';
                });
            },
            
            filterByCategory: function(category) {
                const notes = document.querySelectorAll('.note-item');
                
                notes.forEach(note => {
                    const noteCategory = note.getAttribute('data-category');
                    const matches = !category || noteCategory === category;
                    note.style.display = matches ? 'block' : 'none';
                });
            },
            
            exportNotes: function() {
                const dataStr = JSON.stringify(this.notes, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `noobomega_notes_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            },
            
            renderMarkdown: function(text) {
                // ç®€å•çš„Markdownæ¸²æŸ“
                return this.escapeHtml(text)
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
            },
            
            saveNotes: function() {
                localStorage.setItem('blogNotes', JSON.stringify(this.notes));
            },
            
            escapeHtml: function(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            notesManager.init();
        });
    </script>
</body>
</html>
